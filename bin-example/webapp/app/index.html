<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Salt Bin Example</title>
    <meta name="description" content="Example application using Salt to generate Bin tiles">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.css" />

    <style>
      #map, html, body {
        width: 100%; height: 100%; padding: 0; margin: 0;
      }
    </style>

  </head>

  <body>
    <div id="map"></div>
  </body>

  <script src="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.js"></script>
  <script src="js/jquery-2.1.4.min.js"></script>

  <script>
    // Map control
    var map = new L.Map('map', {
      zoomControl: true,
      center: [40.7, -73.9],
      zoom: 11,
      maxZoom: 14
    });

    // Base map
    L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
      attribution: 'CartoDB'
    }).addTo(map);

    // Get the layer meta data
    $.getJSON('./meta/pickups/meta.json', function( meta ) {
        // Create the canvas tile layer
        var pickupsLayer = new L.tileLayer.canvas({
            url: './tiles/pickups/{z}/{x}/{y}.bins'
        });

        var getArrayBuffer = function( url, callback ) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'arraybuffer';
            xhr.onload = function(e) {
              if (this.status == 200) {
                //Do your stuff here
                callback( new Float64Array(this.response) );
              }
            };
            xhr.send();
        }

        // Defines the two color values to interpolate between
        var fromColor = { r: 150, g: 0, b: 0, a: 50 };
        var toColor = { r: 255, g: 255, b: 50, a: 255 };

        var logTransform = function(value, min, max) {
          var logMin = Math.log(Math.max(1, min))
          var logMax = Math.log(Math.max(1, max))
          var oneOverLogRange = 1 / (logMax - logMin)
          return Math.log(value - logMin) * oneOverLogRange
        }

        var interpolateColor = function(value, min, max) {
          var alpha = logTransform(value, min, max)
          if (value === 0) {
            return {
                r: 255,
                g: 255,
                b: 255,
                a: 0
            };
          } else {
            return {
              r: toColor.r * alpha + fromColor.r * (1 - alpha),
              g: toColor.g * alpha + fromColor.g * (1 - alpha),
              b: toColor.b * alpha + fromColor.b * (1 - alpha),
              a: toColor.a * alpha + fromColor.a * (1 - alpha)
            };
          }
        }

        pickupsLayer.drawTile = function( canvas, index, zoom ) {
            getArrayBuffer('./tiles/pickups/'+zoom+'/'+index.x+'/'+index.y+'.bins', function( bins ) {
                var ctx = canvas.getContext("2d");
                var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                var data = imageData.data;
                var minMax = meta[zoom];
                var rgba;
                for (var i=0; i<bins.length; i++) {
                  rgba = interpolateColor( bins[i], minMax.min, minMax.max );
                  data[i*4] = rgba.r;
                  data[i*4+1] = rgba.g;
                  data[i*4+2] = rgba.b;
                  data[i*4+3] = rgba.a;
                }
                // overwrite original image
                ctx.putImageData(imageData, 0, 0);
            });
        };
        pickupsLayer.addTo(map);
        
    });

  </script>
</html>
